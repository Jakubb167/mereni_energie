<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot≈ôeba Energie - Live Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.8s;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            background: rgba(102, 126, 234, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 15px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px #4ade80;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1em;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .last-update {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .stat-timestamp {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            font-style: italic;
        }

        .stat-meta {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 10px;
            line-height: 1.6;
        }

        .stat-trend {
            font-size: 0.95em;
            font-weight: 600;
            margin: 8px 0;
        }

        .stat-trend.up {
            color: #ef4444;
        }

        .stat-trend.down {
            color: #10b981;
        }

        .filters {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters label {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .filters select, .filters input {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            backdrop-filter: blur(10px);
        }

        .filters select option {
            background: #1a1a2e;
            color: #fff;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(102, 126, 234, 0.3);
        }

        .chart-container h2 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .chart-slider-container {
            margin-top: 15px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
        }

        .chart-slider {
            position: relative;
            height: 60px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 6px;
            overflow: visible;
            cursor: pointer;
            user-select: none;
        }

        .chart-slider-preview {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0.3;
            pointer-events: none;
        }

        .chart-slider-window {
            position: absolute;
            height: 100%;
            background: rgba(102, 126, 234, 0.3);
            border: 2px solid #667eea;
            border-radius: 4px;
            cursor: move;
            min-width: 50px;
            box-sizing: border-box;
        }

        .chart-slider-handle {
            position: absolute;
            top: 0;
            width: 12px;
            height: 100%;
            background: #667eea;
            cursor: ew-resize;
            z-index: 10;
            box-sizing: border-box;
        }

        .chart-slider-handle.left {
            left: 0;
            border-radius: 4px 0 0 4px;
        }

        .chart-slider-handle.right {
            right: 0;
            border-radius: 0 4px 4px 0;
        }

        .slider-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.8em;
            color: rgba(255, 255, 255, 0.6);
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .heatmap-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .heatmap-wrapper {
            position: relative;
            width: 100%;
            overflow-x: visible;
            overflow-y: visible;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 0;
            width: 100%;
        }

        .heatmap-y-labels {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .heatmap-y-label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            padding-right: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 20px;
        }

        .heatmap-content-wrapper {
            display: flex;
            flex-direction: column;
        }

        .heatmap-x-labels {
            display: flex;
            height: 30px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 0;
        }

        .heatmap-month-label {
            position: absolute;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            transform: translateX(-50%);
            top: 8px;
        }

        .heatmap-data {
            display: flex;
            gap: 0;
        }

        .heatmap-day-column {
            display: flex;
            flex-direction: column;
            gap: 0;
            flex: 1;
            min-width: 2px;
        }

        .heatmap-hour-cell {
            height: 20px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .heatmap-hour-cell:hover {
            transform: scale(1.5);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .heatmap-legend-gradient {
            flex: 1;
            height: 25px;
            border-radius: 5px;
            background: linear-gradient(to right, 
                #ffffc8, #ffff80, #ffff00, #ffd700,
                #ffa500, #ff6600, #ff3300, #ff0000, #990000, #330000
            );
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.5em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #ff6b6b;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.3);
            color: #51cf66;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: fadeIn 0.5s;
            backdrop-filter: blur(10px);
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-controls button {
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.3);
            color: white;
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .chart-controls button:hover {
            background: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .cost-display {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .cost-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffc107;
            margin: 5px 0;
        }

        .page-title {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .chart-grid { grid-template-columns: 1fr; }
            .stats-grid { grid-template-columns: 1fr; }
            .stat-value { font-size: 2.2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Dashboard Spot≈ôeby Energie</h1>
            <p class="subtitle">Real-time monitoring odbƒõru elektrick√© energie</p>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE DATA - SQL Datab√°ze</span>
            </div>
            <div style="margin-top: 15px; font-size: 1.1em; font-weight: 600; color: rgba(255,255,255,0.9);">
                üïê <span id="currentTime">Naƒç√≠t√°n√≠...</span>
            </div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" data-page="overview" onclick="switchPage('overview', this)">üìä P≈ôehled</div>
                <div class="nav-tab" data-page="aggregated" onclick="switchPage('aggregated', this)">üìà Agregovan√° spot≈ôeba</div>
                <div class="nav-tab" data-page="statistics" onclick="switchPage('statistics', this)">üìâ Detailn√≠ statistiky</div>
                <div class="nav-tab" data-page="heatmap" onclick="switchPage('heatmap', this)">üî• Heatmapa</div>
            </div>
        </header>

        <div id="lastUpdate" class="last-update"></div>
        <div id="loading" class="loading">‚è≥ Naƒç√≠t√°m data z SQL datab√°ze</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div class="filters" id="filters" style="display: none;">
            <div class="filter-group">
                <label>üìÖ Obdob√≠:</label>
                <select id="timeRange" onchange="updateCharts()">
                    <option value="1">Posledn√≠ den</option>
                    <option value="3">Posledn√≠ 3 dny</option>
                    <option value="7" selected>Posledn√≠ch 7 dn√≠</option>
                    <option value="14">Posledn√≠ch 14 dn√≠</option>
                    <option value="30">Posledn√≠ch 30 dn√≠</option>
                    <option value="90">Posledn√≠ch 90 dn√≠</option>
                    <option value="365">Cel√Ω rok</option>
                </select>
            </div>
            
            <div class="filter-group">
                <label>üí∞ Cena kWh:</label>
                <input type="number" id="pricePerKwh" value="4.5" step="0.1" min="0" onchange="updateCharts()" style="width: 100px;">
                <span>Kƒç</span>
            </div>

            <button class="btn" onclick="loadData()" style="margin-left: auto;">
                üîÑ Obnovit data
            </button>
        </div>

        <!-- Str√°nka 1: P≈ôehled -->
        <div id="page-overview" class="page-section active">
            <div class="stats-grid" id="statsGrid" style="display: none;"></div>

            <div class="chart-grid" id="chartsGrid" style="display: none;">
                <div class="chart-container">
                    <h2>üìä Kumulativn√≠ spot≈ôeba</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('consumption')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('consumption')">üîç+</button>
                        <button onclick="zoomOut('consumption')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="consumptionChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="consumptionSlider">
                            <canvas class="chart-slider-preview" id="consumptionSliderPreview"></canvas>
                            <div class="chart-slider-window" id="consumptionSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="consumptionSliderStart">-</span>
                            <span id="consumptionSliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üìâ P≈ô√≠r≈Østek spot≈ôeby</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 10px; font-size: 0.85em;">Rozd√≠l spot≈ôeby mezi mƒõ≈ôen√≠mi</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('delta')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('delta')">üîç+</button>
                        <button onclick="zoomOut('delta')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="deltaChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="deltaSlider">
                            <canvas class="chart-slider-preview" id="deltaSliderPreview"></canvas>
                            <div class="chart-slider-window" id="deltaSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="deltaSliderStart">-</span>
                            <span id="deltaSliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>‚ö° Okam≈æit√Ω v√Ωkon</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('power')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('power')">üîç+</button>
                        <button onclick="zoomOut('power')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="powerChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="powerSlider">
                            <canvas class="chart-slider-preview" id="powerSliderPreview"></canvas>
                            <div class="chart-slider-window" id="powerSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="powerSliderStart">-</span>
                            <span id="powerSliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üîå Napƒõt√≠</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('voltage')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('voltage')">üîç+</button>
                        <button onclick="zoomOut('voltage')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="voltageChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="voltageSlider">
                            <canvas class="chart-slider-preview" id="voltageSliderPreview"></canvas>
                            <div class="chart-slider-window" id="voltageSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="voltageSliderStart">-</span>
                            <span id="voltageSliderEnd">-</span>
                        </div>
                    </div>
                </div>

                <div class="chart-container">
                    <h2>üåä Proud</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('current')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('current')">üîç+</button>
                        <button onclick="zoomOut('current')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="currentChart"></canvas>
                    </div>
                    <div class="chart-slider-container">
                        <div class="chart-slider" id="currentSlider">
                            <canvas class="chart-slider-preview" id="currentSliderPreview"></canvas>
                            <div class="chart-slider-window" id="currentSliderWindow">
                                <div class="chart-slider-handle left"></div>
                                <div class="chart-slider-handle right"></div>
                            </div>
                        </div>
                        <div class="slider-labels">
                            <span id="currentSliderStart">-</span>
                            <span id="currentSliderEnd">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Str√°nka 2: Agregovan√° spot≈ôeba -->
        <div id="page-aggregated" class="page-section">
            <h2 class="page-title">üìà Agregovan√° spot≈ôeba</h2>
            <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 30px;">Celkov√° spot≈ôeba za jednotliv√° obdob√≠</p>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <h2>üìÖ Spot≈ôeba po dnech</h2>
                    <div class="chart-wrapper">
                        <canvas id="dailyConsumptionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>üìÜ Spot≈ôeba po mƒõs√≠c√≠ch</h2>
                    <div class="chart-wrapper">
                        <canvas id="monthlyConsumptionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container full-width">
                    <h2>üìä Spot≈ôeba po roc√≠ch</h2>
                    <div class="chart-wrapper">
                        <canvas id="yearlyConsumptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Str√°nka 3: Detailn√≠ statistiky -->
        <div id="page-statistics" class="page-section">
            <h2 class="page-title">üìâ Detailn√≠ statistiky</h2>
            <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 30px;">Podrobn√© statistick√© √∫daje za vybran√© obdob√≠</p>
            <div id="statisticsGrid" class="stats-grid"></div>
        </div>

        <!-- Str√°nka 4: Heatmapa -->
        <div id="page-heatmap" class="page-section">
            <h2 class="page-title">üî• Roƒçn√≠ heatmapa spot≈ôeby</h2>
            <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 30px;">Pr≈Ømƒõrn√Ω odbƒõr podle dne v roce a hodiny</p>
            
            <div class="heatmap-container">
                <div class="heatmap-wrapper">
                    <div id="heatmapGrid"></div>
                </div>
                <div class="heatmap-legend">
                    <span style="font-size: 0.85em; color: rgba(255,255,255,0.8); font-weight: 600;">V√Ωkon:</span>
                    <span style="font-size: 0.85em; color: rgba(255,255,255,0.7);" id="heatmapMin">0W</span>
                    <div class="heatmap-legend-gradient"></div>
                    <span style="font-size: 0.85em; color: rgba(255,255,255,0.7);" id="heatmapMax">3000W</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================================
        // KONFIGURACE - ZMƒöNTE TUTO URL NA VA≈†I PHP ENDPOINT
        // ============================================================
        const PHP_DATA_URL = 'https://shrill-sunset-56af.baborovsky-jakub.workers.dev/';
        const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000; // 5 minut

        let rawData = [];          // energie data
        let spotrebaData = [];     // spotreba data  
        let filteredData = [];     // filtered energie
        let filteredSpotreba = []; // filtered spotreba
        let charts = {};
        let sliders = {};
        let currentPage = 'overview';

        // ============================================================
        // INICIALIZACE
        // ============================================================
        window.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            loadData();
            setInterval(loadData, AUTO_REFRESH_INTERVAL);
        });

        function updateCurrentTime() {
            const now = new Date();
            const el = document.getElementById('currentTime');
            if (el) {
                el.textContent = now.toLocaleDateString('cs-CZ', { day: '2-digit', month: '2-digit', year: 'numeric' }) + ' ' +
                                 now.toLocaleTimeString('cs-CZ', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false });
            }
        }

        function switchPage(pageName, el) {
            currentPage = pageName;
            document.querySelectorAll('.page-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('page-' + pageName).classList.add('active');
            el.classList.add('active');
        }

        function formatDateTime(date) {
            return date.toLocaleString('cs-CZ', {
                day: '2-digit', month: '2-digit', year: 'numeric',
                hour: '2-digit', minute: '2-digit', hour12: false
            });
        }

        // ============================================================
        // LOADING DATA FROM PHP / SQL
        // ============================================================
        async function loadData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';

            // Fetch with max days = 365 so we always have full data for heatmap
            const url = PHP_DATA_URL + '?days=365';

            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error('HTTP ' + response.status);
                const json = await response.json();
                if (json.status !== 'success') throw new Error(json.message || 'Nezn√°m√° chyba');

                // Split combined data back into energie and spotreba
                rawData = [];
                spotrebaData = [];

                json.data.forEach(row => {
                    const dt = new Date(row.datum_a_cas.replace(' ', 'T'));
                    if (isNaN(dt.getTime())) return;

                    if (row.vykon !== null) {
                        rawData.push({
                            datetime: dt,
                            vykonW: row.vykon,
                            napeti: row.napeti,
                            proud:  row.proud
                        });
                    }
                    if (row.spotreba !== null) {
                        spotrebaData.push({
                            datetime: dt,
                            spotreba: row.spotreba
                        });
                    }
                });

                // Sort
                rawData.sort((a, b) => a.datetime - b.datetime);
                spotrebaData.sort((a, b) => a.datetime - b.datetime);

                // Compute cumulative spotreba
                let cumulative = 0;
                spotrebaData.forEach(d => {
                    cumulative += d.spotreba;
                    d.kumulativniSpotrebaKwh = cumulative;
                });

                document.getElementById('loading').style.display = 'none';
                document.getElementById('filters').style.display = 'flex';
                document.getElementById('statsGrid').style.display = 'grid';
                document.getElementById('chartsGrid').style.display = 'grid';

                document.getElementById('lastUpdate').textContent =
                    `Posledn√≠ aktualizace: ${formatDateTime(new Date())} | Energie: ${rawData.length} z√°znam≈Ø | Spot≈ôeba: ${spotrebaData.length} z√°znam≈Ø`;

                document.getElementById('success').textContent =
                    `‚úÖ √öspƒõ≈°nƒõ naƒçteno ${rawData.length} mƒõ≈ôen√≠ energie a ${spotrebaData.length} mƒõ≈ôen√≠ spot≈ôeby!`;
                document.getElementById('success').style.display = 'block';
                setTimeout(() => { document.getElementById('success').style.display = 'none'; }, 5000);

                if (Object.keys(charts).length === 0) {
                    initializeCharts();
                    initializeSliders();
                }
                updateCharts();

            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').textContent = '‚ùå ' + error.message;
                document.getElementById('error').style.display = 'block';
            }
        }

        // ============================================================
        // FILTERING
        // ============================================================
        function updateCharts() {
            const range = document.getElementById('timeRange')?.value || '7';
            const days = parseInt(range);

            const cutoff = new Date();
            cutoff.setDate(cutoff.getDate() - days);

            filteredData = rawData.filter(d => d.datetime >= cutoff);
            filteredSpotreba = spotrebaData.filter(d => d.datetime >= cutoff);

            // Recompute cumulative for filtered spotreba
            let cum = 0;
            filteredSpotreba.forEach(d => {
                cum += d.spotreba;
                d.kumulativniSpotrebaKwh = cum;
            });

            updateStats();
            updateAllCharts();
            updateAggregatedCharts();
            updateStatistics();
            updateHeatmap();

            // Reset sliders
            ['delta', 'consumption', 'power', 'voltage', 'current'].forEach(name => {
                const sw = document.getElementById(`${name}SliderWindow`);
                if (sw) { sw.style.left = '0%'; sw.style.width = '100%'; sw.style.right = ''; }
            });
        }

        // ============================================================
        // STATS CARDS
        // ============================================================
        function updateStats() {
            const pricePerKwh = parseFloat(document.getElementById('pricePerKwh')?.value || 4.5);
            const data = filteredData;
            const sdata = filteredSpotreba;

            const vykon  = calcStatsWithTime(data.map(d => ({ value: d.vykonW, time: d.datetime })));
            const napeti = calcStatsWithTime(data.map(d => ({ value: d.napeti, time: d.datetime })));
            const proud  = calcStatsWithTime(data.map(d => ({ value: d.proud,  time: d.datetime })));

            const totalConsumption = sdata.length > 0 ? sdata[sdata.length - 1].kumulativniSpotrebaKwh : 0;
            const totalCost = totalConsumption * pricePerKwh;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">OKAM≈ΩIT√ù V√ùKON</div>
                    <div class="stat-value">${vykon.current.value.toFixed(0)} W</div>
                    <div class="stat-timestamp">üìÖ ${formatDateTime(vykon.current.time)}</div>
                    <div class="stat-trend ${vykon.trend >= 0 ? 'up' : 'down'}">
                        ${vykon.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(vykon.trend).toFixed(0)} W od p≈ôedchoz√≠ho
                    </div>
                    <div class="stat-meta">
                        Max: ${vykon.max.value.toFixed(0)} W<br>
                        <small>${formatDateTime(vykon.max.time)}</small><br>
                        Pr≈Ømƒõr: ${vykon.avg.toFixed(0)} W
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">CELKOV√Å SPOT≈òEBA</div>
                    <div class="stat-value">${totalConsumption.toFixed(2)} kWh</div>
                    <div class="stat-timestamp">Za zvolen√© obdob√≠</div>
                    <div class="cost-display">
                        <div style="font-size: 0.9em; opacity: 0.8;">N√°klady</div>
                        <div class="cost-value">${totalCost.toFixed(2)} Kƒç</div>
                        <div style="font-size: 0.8em; opacity: 0.7;">p≈ôi ${pricePerKwh} Kƒç/kWh</div>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîå</div>
                    <div class="stat-label">NAPƒöT√ç</div>
                    <div class="stat-value">${napeti.current.value.toFixed(1)} V</div>
                    <div class="stat-timestamp">üìÖ ${formatDateTime(napeti.current.time)}</div>
                    <div class="stat-trend ${napeti.trend >= 0 ? 'up' : 'down'}">
                        ${napeti.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(napeti.trend).toFixed(1)} V
                    </div>
                    <div class="stat-meta">
                        Min: ${napeti.min.value.toFixed(1)} V<br>
                        <small>${formatDateTime(napeti.min.time)}</small><br>
                        Max: ${napeti.max.value.toFixed(1)} V<br>
                        <small>${formatDateTime(napeti.max.time)}</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåä</div>
                    <div class="stat-label">PROUD</div>
                    <div class="stat-value">${proud.current.value.toFixed(2)} A</div>
                    <div class="stat-timestamp">üìÖ ${formatDateTime(proud.current.time)}</div>
                    <div class="stat-trend ${proud.trend >= 0 ? 'up' : 'down'}">
                        ${proud.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(proud.trend).toFixed(2)} A
                    </div>
                    <div class="stat-meta">
                        Max: ${proud.max.value.toFixed(2)} A<br>
                        <small>${formatDateTime(proud.max.time)}</small><br>
                        Pr≈Ømƒõr: ${proud.avg.toFixed(2)} A
                    </div>
                </div>
            `;
        }

        function calcStatsWithTime(items) {
            if (items.length === 0) return {
                current: {value: 0, time: new Date()},
                min: {value: 0, time: new Date()},
                max: {value: 0, time: new Date()},
                avg: 0, trend: 0
            };
            const current  = items[items.length - 1];
            const previous = items[Math.max(0, items.length - 10)];
            const minVal = Math.min(...items.map(i => i.value));
            const maxVal = Math.max(...items.map(i => i.value));
            return {
                current,
                min: items.find(i => i.value === minVal),
                max: items.find(i => i.value === maxVal),
                avg: items.reduce((a, i) => a + i.value, 0) / items.length,
                trend: current.value - previous.value
            };
        }

        // ============================================================
        // CHART INITIALIZATION
        // ============================================================
        function initializeCharts() {
            const zoomOptions = {
                zoom: { wheel: { enabled: true, speed: 0.1 }, pinch: { enabled: true }, mode: 'x' },
                pan:  { enabled: true, mode: 'x' }
            };
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: true, labels: { color: 'rgba(255,255,255,0.8)' } },
                    zoom: zoomOptions,
                    tooltip: { mode: 'index', intersect: false, backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff' },
                    annotation: { annotations: {} }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { unit: 'hour', displayFormats: { hour: 'HH:mm', day: 'dd.MM' }, tooltipFormat: 'dd.MM.yyyy HH:mm' },
                        ticks: { color: 'rgba(255,255,255,0.7)' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            };

            const yAxis = (label) => ({
                title: { display: true, text: label, color: 'rgba(255,255,255,0.8)' },
                ticks: { color: 'rgba(255,255,255,0.7)' },
                grid: { color: 'rgba(255,255,255,0.1)' }
            });

            charts.consumption = new Chart(document.getElementById('consumptionChart'), {
                type: 'line', data: { datasets: [] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: yAxis('kWh') } }
            });

            charts.delta = new Chart(document.getElementById('deltaChart'), {
                type: 'bar', data: { datasets: [] },
                options: { ...commonOptions, barPercentage: 1.0, categoryPercentage: 1.0, scales: { ...commonOptions.scales, y: yAxis('kWh') } }
            });

            charts.power = new Chart(document.getElementById('powerChart'), {
                type: 'line', data: { datasets: [] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: yAxis('W') } }
            });

            charts.voltage = new Chart(document.getElementById('voltageChart'), {
                type: 'line', data: { datasets: [] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: yAxis('V') } }
            });

            charts.current = new Chart(document.getElementById('currentChart'), {
                type: 'line', data: { datasets: [] },
                options: { ...commonOptions, scales: { ...commonOptions.scales, y: yAxis('A') } }
            });

            const aggOptions = {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(0,0,0,0.8)', titleColor: '#fff', bodyColor: '#fff' } },
                scales: {
                    x: { ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                    y: { title: { display: true, text: 'kWh', color: 'rgba(255,255,255,0.8)' }, ticks: { color: 'rgba(255,255,255,0.7)' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                }
            };

            charts.dailyConsumption   = new Chart(document.getElementById('dailyConsumptionChart'),   { type: 'bar', data: { datasets: [] }, options: aggOptions });
            charts.monthlyConsumption = new Chart(document.getElementById('monthlyConsumptionChart'), { type: 'bar', data: { datasets: [] }, options: aggOptions });
            charts.yearlyConsumption  = new Chart(document.getElementById('yearlyConsumptionChart'),  { type: 'bar', data: { datasets: [] }, options: aggOptions });
        }

        // ============================================================
        // CHART UPDATE
        // ============================================================
        function updateAllCharts() {
            const data  = filteredData;
            const sdata = filteredSpotreba;

            // --- Consumption (cumulative) from spotreba table ---
            charts.consumption.data.datasets = [{
                label: 'Kumulativn√≠ spot≈ôeba (kWh)',
                data: sdata.map(d => ({ x: d.datetime, y: d.kumulativniSpotrebaKwh })),
                borderColor: '#4caf50', backgroundColor: 'rgba(76, 175, 80, 0.2)',
                tension: 0.4, fill: true, pointRadius: 2
            }];
            charts.consumption.options.scales.x.min = undefined;
            charts.consumption.options.scales.x.max = undefined;

            // --- Delta (individual spotreba values) ---
            const deltaData = sdata.filter(d => d.spotreba > 0).map(d => ({ x: d.datetime, y: d.spotreba }));
            charts.delta.data.datasets = [{
                label: 'P≈ô√≠r≈Østek spot≈ôeby (kWh)',
                data: deltaData,
                backgroundColor: 'rgba(255, 193, 7, 0.8)', borderColor: 'rgba(255, 193, 7, 1)', borderWidth: 1
            }];
            charts.delta.options.scales.x.min = undefined;
            charts.delta.options.scales.x.max = undefined;

            // --- Power from energie table ---
            charts.power.data.datasets = [{
                label: 'V√Ωkon (W)',
                data: data.map(d => ({ x: d.datetime, y: d.vykonW })),
                borderColor: '#ff9800', backgroundColor: 'rgba(255, 152, 0, 0.2)',
                tension: 0.4, fill: true, pointRadius: 2
            }];
            charts.power.options.scales.x.min = undefined;
            charts.power.options.scales.x.max = undefined;

            // --- Voltage ---
            charts.voltage.data.datasets = [{
                label: 'Napƒõt√≠ (V)',
                data: data.map(d => ({ x: d.datetime, y: d.napeti })),
                borderColor: '#2196f3', backgroundColor: 'rgba(33, 150, 243, 0.2)',
                tension: 0.4, fill: true, pointRadius: 2
            }];
            charts.voltage.options.scales.x.min = undefined;
            charts.voltage.options.scales.x.max = undefined;

            // --- Current ---
            charts.current.data.datasets = [{
                label: 'Proud (A)',
                data: data.map(d => ({ x: d.datetime, y: d.proud })),
                borderColor: '#9c27b0', backgroundColor: 'rgba(156, 39, 176, 0.2)',
                tension: 0.4, fill: true, pointRadius: 2
            }];
            charts.current.options.scales.x.min = undefined;
            charts.current.options.scales.x.max = undefined;

            // Midnight lines
            const allDates = [...data.map(d => d.datetime), ...sdata.map(d => d.datetime)];
            if (allDates.length > 0) {
                const daysDiff = (Math.max(...allDates) - Math.min(...allDates)) / (1000 * 60 * 60 * 24);
                if (daysDiff <= 60) {
                    ['delta','consumption','power','voltage','current'].forEach(name => addMidnightLines(charts[name], allDates));
                } else {
                    ['delta','consumption','power','voltage','current'].forEach(name => {
                        if (charts[name]?.options?.plugins?.annotation) charts[name].options.plugins.annotation.annotations = {};
                    });
                }
            }

            Object.values(charts).forEach(c => { if (c.data.datasets.length) c.update(); });

            // Slider previews
            drawSliderPreview('consumption', sdata, d => d.kumulativniSpotrebaKwh);
            drawSliderPreview('delta',       sdata, d => d.spotreba);
            drawSliderPreview('power',       data,  d => d.vykonW);
            drawSliderPreview('voltage',     data,  d => d.napeti);
            drawSliderPreview('current',     data,  d => d.proud);
        }

        function addMidnightLines(chart, dates) {
            if (!chart || !dates.length) return;
            const start = new Date(Math.min(...dates));
            const end   = new Date(Math.max(...dates));
            let cur = new Date(start); cur.setHours(0,0,0,0); cur.setDate(cur.getDate()+1);
            if (!chart.options.plugins) chart.options.plugins = {};
            if (!chart.options.plugins.annotation) chart.options.plugins.annotation = { annotations: {} };
            chart.options.plugins.annotation.annotations = {};
            let idx = 0;
            while (cur <= end) {
                chart.options.plugins.annotation.annotations[`m${idx}`] = {
                    type: 'line', xMin: cur.getTime(), xMax: cur.getTime(),
                    borderColor: 'rgba(255,255,255,0.3)', borderWidth: 2, borderDash: [5,5]
                };
                cur = new Date(cur); cur.setDate(cur.getDate()+1); idx++;
            }
        }

        // ============================================================
        // AGGREGATED CHARTS
        // ============================================================
        function updateAggregatedCharts() {
            const sdata = filteredSpotreba;
            if (!sdata.length) return;

            // Daily
            const daily = {};
            sdata.forEach(d => {
                const key = d.datetime.toLocaleDateString('cs-CZ');
                daily[key] = (daily[key] || 0) + d.spotreba;
            });
            charts.dailyConsumption.data = {
                labels: Object.keys(daily),
                datasets: [{ label: 'Spot≈ôeba (kWh)', data: Object.values(daily), backgroundColor: 'rgba(76,175,80,0.8)', borderColor: 'rgba(76,175,80,1)', borderWidth: 1 }]
            };
            charts.dailyConsumption.update();

            // Monthly
            const monthly = {};
            sdata.forEach(d => {
                const key = `${d.datetime.getFullYear()}-${String(d.datetime.getMonth()+1).padStart(2,'0')}`;
                monthly[key] = (monthly[key] || 0) + d.spotreba;
            });
            const monthNames = ['Led','√öno','B≈ôe','Dub','Kvƒõ','ƒåvn','ƒåvc','Srp','Z√°≈ô','≈ò√≠j','Lis','Pro'];
            charts.monthlyConsumption.data = {
                labels: Object.keys(monthly).map(k => { const [y,m] = k.split('-'); return `${monthNames[parseInt(m)-1]} ${y}`; }),
                datasets: [{ label: 'Spot≈ôeba (kWh)', data: Object.values(monthly), backgroundColor: 'rgba(33,150,243,0.8)', borderColor: 'rgba(33,150,243,1)', borderWidth: 1 }]
            };
            charts.monthlyConsumption.update();

            // Yearly
            const yearly = {};
            sdata.forEach(d => {
                const y = d.datetime.getFullYear();
                yearly[y] = (yearly[y] || 0) + d.spotreba;
            });
            charts.yearlyConsumption.data = {
                labels: Object.keys(yearly),
                datasets: [{ label: 'Spot≈ôeba (kWh)', data: Object.values(yearly), backgroundColor: 'rgba(156,39,176,0.8)', borderColor: 'rgba(156,39,176,1)', borderWidth: 1 }]
            };
            charts.yearlyConsumption.update();
        }

        // ============================================================
        // STATISTICS PAGE
        // ============================================================
        function updateStatistics() {
            const data  = filteredData;
            const sdata = filteredSpotreba;
            if (!data.length || !sdata.length) {
                document.getElementById('statisticsGrid').innerHTML = '<p style="color:rgba(255,255,255,0.6);">Nedostatek dat</p>';
                return;
            }

            const pricePerKwh = parseFloat(document.getElementById('pricePerKwh')?.value || 4.5);
            const powers    = data.map(d => d.vykonW);
            const voltages  = data.map(d => d.napeti);
            const currents  = data.map(d => d.proud);

            const totalConsumption = sdata.reduce((a, d) => a + d.spotreba, 0);
            const avgPower  = powers.reduce((a,b) => a+b, 0) / powers.length;
            const maxPower  = Math.max(...powers);
            const minPower  = Math.min(...powers);
            const maxPowerTime = data[powers.indexOf(maxPower)].datetime;
            const minPowerTime = data[powers.indexOf(minPower)].datetime;

            // Hourly avg power
            const hCons = Array(24).fill(0), hCnt = Array(24).fill(0);
            data.forEach(d => { const h = d.datetime.getHours(); hCons[h] += d.vykonW; hCnt[h]++; });
            const avgHourly = hCons.map((s,i) => hCnt[i] > 0 ? s/hCnt[i] : 0);
            const peakHour = avgHourly.indexOf(Math.max(...avgHourly));
            const offPeakHour = avgHourly.indexOf(Math.min(...avgHourly.filter(p => p > 0)));

            // Weekday
            const wCons = Array(7).fill(0), wCnt = Array(7).fill(0);
            data.forEach(d => { const day = d.datetime.getDay(); wCons[day] += d.vykonW; wCnt[day]++; });
            const avgWeekday = wCons.map((s,i) => wCnt[i] > 0 ? s/wCnt[i] : 0);
            const peakWeekday = avgWeekday.indexOf(Math.max(...avgWeekday));
            const weekdayNames = ['Nedƒõle','Pondƒõl√≠','√öter√Ω','St≈ôeda','ƒåtvrtek','P√°tek','Sobota'];

            const allTimes = [...data.map(d=>d.datetime), ...sdata.map(d=>d.datetime)];
            const timeSpan = (Math.max(...allTimes) - Math.min(...allTimes)) / (1000*60*60*24) || 1;
            const avgDailyConsumption = totalConsumption / timeSpan;
            const avgVoltage  = voltages.reduce((a,b)=>a+b,0) / voltages.length;
            const avgCurrent  = currents.reduce((a,b)=>a+b,0) / currents.length;
            const powerFactor = avgPower / (avgVoltage * avgCurrent);
            const totalCost   = totalConsumption * pricePerKwh;
            const avgDailyCost = totalCost / timeSpan;

            document.getElementById('statisticsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">OBDOB√ç</div>
                    <div class="stat-value">${timeSpan.toFixed(1)}</div>
                    <div class="stat-meta">dn≈Ø monitorov√°n√≠<br>Od: ${formatDateTime(new Date(Math.min(...allTimes)))}<br>Do: ${formatDateTime(new Date(Math.max(...allTimes)))}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">PR≈ÆMƒöRN√ù V√ùKON</div>
                    <div class="stat-value">${avgPower.toFixed(0)} W</div>
                    <div class="stat-meta">Maximum: ${maxPower.toFixed(0)} W<br><small>${formatDateTime(maxPowerTime)}</small><br>Minimum: ${minPower.toFixed(0)} W<br><small>${formatDateTime(minPowerTime)}</small></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üïê</div>
                    <div class="stat-label">≈†PIƒåKA DNE</div>
                    <div class="stat-value">${peakHour}:00</div>
                    <div class="stat-meta">Pr≈Ømƒõrn√Ω v√Ωkon: ${avgHourly[peakHour].toFixed(0)} W<br>Nejni≈æ≈°√≠: ${offPeakHour}:00 (${avgHourly[offPeakHour].toFixed(0)} W)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-label">NEJVY≈†≈†√ç DEN</div>
                    <div class="stat-value">${weekdayNames[peakWeekday]}</div>
                    <div class="stat-meta">Pr≈Ømƒõrn√Ω v√Ωkon: ${avgWeekday[peakWeekday].toFixed(0)} W</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-label">DENN√ç SPOT≈òEBA</div>
                    <div class="stat-value">${avgDailyConsumption.toFixed(2)}</div>
                    <div class="stat-meta">kWh/den (pr≈Ømƒõr)</div>
                    <div class="cost-display"><div style="font-size:0.9em;opacity:0.8;">Denn√≠ n√°klady</div><div class="cost-value">${avgDailyCost.toFixed(2)} Kƒç</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">PROJEKCE N√ÅKLAD≈Æ</div>
                    <div class="stat-value">${(avgDailyCost*30).toFixed(0)}</div>
                    <div class="stat-meta">Kƒç/mƒõs√≠c (odhad)<br>Roƒçn√≠ odhad: ${(avgDailyCost*365).toFixed(0)} Kƒç</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîå</div>
                    <div class="stat-label">√öƒåIN√çK</div>
                    <div class="stat-value">${powerFactor.toFixed(3)}</div>
                    <div class="stat-meta">Power Factor (cos œÜ)<br><small>${powerFactor > 0.95 ? 'V√Ωborn√Ω' : powerFactor > 0.85 ? 'Dobr√Ω' : 'Ke zlep≈°en√≠'}</small></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Mƒö≈òEN√ç</div>
                    <div class="stat-value">${data.length}</div>
                    <div class="stat-meta">Energie: ${data.length} z√°znam≈Ø<br>Spot≈ôeba: ${sdata.length} z√°znam≈Ø<br>Interval energie: ${((timeSpan*24*60)/data.length).toFixed(1)} min</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">‚öôÔ∏è</div>
                    <div class="stat-label">STABILITA NAPƒöT√ç</div>
                    <div class="stat-value">${avgVoltage.toFixed(1)} V</div>
                    <div class="stat-meta">Max: ${Math.max(...voltages).toFixed(1)} V<br>Min: ${Math.min(...voltages).toFixed(1)} V<br>Rozptyl: ${(Math.max(...voltages)-Math.min(...voltages)).toFixed(1)} V</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåä</div>
                    <div class="stat-label">PR≈ÆMƒöRN√ù PROUD</div>
                    <div class="stat-value">${avgCurrent.toFixed(2)} A</div>
                    <div class="stat-meta">Maximum: ${Math.max(...currents).toFixed(2)} A<br>Minimum: ${Math.min(...currents).toFixed(2)} A</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">CELKEM ZA OBDOB√ç</div>
                    <div class="stat-value">${totalConsumption.toFixed(2)}</div>
                    <div class="stat-meta">kWh</div>
                    <div class="cost-display"><div style="font-size:0.9em;opacity:0.8;">Celkov√© n√°klady</div><div class="cost-value">${totalCost.toFixed(2)} Kƒç</div></div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí°</div>
                    <div class="stat-label">EFEKTIVITA</div>
                    <div class="stat-value">${(avgPower/1000*24).toFixed(1)}</div>
                    <div class="stat-meta">kWh/den p≈ôi trval√©m pr≈Ømƒõrn√©m v√Ωkonu<br><small>Skuteƒçn√°: ${avgDailyConsumption.toFixed(2)} kWh/den</small></div>
                </div>
            `;
        }

        // ============================================================
        // HEATMAP
        // ============================================================
        function updateHeatmap() {
            const currentYear = new Date().getFullYear();
            const daysInYear = isLeapYear(currentYear) ? 366 : 365;
            const matrix = Array(daysInYear).fill(null).map(() => Array(24).fill(null).map(() => []));

            // Use energie (power) data for heatmap
            rawData.forEach(d => {
                if (d.datetime.getFullYear() !== currentYear) return;
                const day = getDayOfYear(d.datetime);
                const hour = d.datetime.getHours();
                if (day >= 0 && day < daysInYear && hour >= 0 && hour < 24) matrix[day][hour].push(d.vykonW);
            });

            const avgMatrix = matrix.map(day => day.map(h => h.length > 0 ? h.reduce((a,b)=>a+b,0)/h.length : null));
            const allPowers = avgMatrix.flat().filter(p => p !== null);
            if (!allPowers.length) {
                document.getElementById('heatmapGrid').innerHTML = '<p style="color:rgba(255,255,255,0.6);padding:20px;">Nedostatek dat pro heatmapu</p>';
                return;
            }

            const minP = Math.min(...allPowers), maxP = Math.max(...allPowers);
            document.getElementById('heatmapMin').textContent = minP.toFixed(0)+'W';
            document.getElementById('heatmapMax').textContent = maxP.toFixed(0)+'W';

            const heatmapDiv = document.getElementById('heatmapGrid');
            heatmapDiv.innerHTML = '';
            const gridContainer = document.createElement('div');
            gridContainer.className = 'heatmap-grid';

            // Y labels (hours)
            const yLabels = document.createElement('div');
            yLabels.className = 'heatmap-y-labels';
            for (let h = 0; h < 24; h++) {
                const label = document.createElement('div');
                label.className = 'heatmap-y-label';
                label.textContent = h + ':00';
                yLabels.appendChild(label);
            }
            gridContainer.appendChild(yLabels);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'heatmap-content-wrapper';

            // X labels (months)
            const xLabels = document.createElement('div');
            xLabels.className = 'heatmap-x-labels';
            const monthNames = ['Led','√öno','B≈ôe','Dub','Kvƒõ','ƒåvn','ƒåvc','Srp','Z√°≈ô','≈ò√≠j','Lis','Pro'];
            const daysInMonth = [31, isLeapYear(currentYear)?29:28, 31,30,31,30,31,31,30,31,30,31];
            let cumDays = 0;
            monthNames.forEach((m, i) => {
                const ml = document.createElement('div');
                ml.className = 'heatmap-month-label';
                ml.textContent = m;
                ml.style.left = (((cumDays + daysInMonth[i]/2) / daysInYear) * 100) + '%';
                xLabels.appendChild(ml);
                cumDays += daysInMonth[i];
            });
            contentWrapper.appendChild(xLabels);

            // Data cells
            const dataDiv = document.createElement('div');
            dataDiv.className = 'heatmap-data';
            avgMatrix.forEach((dayData, dayIdx) => {
                const col = document.createElement('div');
                col.className = 'heatmap-day-column';
                dayData.forEach((power, hour) => {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-hour-cell';
                    if (power !== null) {
                        cell.style.background = getColorForPower(power, minP, maxP);
                        const date = getDateFromDayOfYear(dayIdx, currentYear);
                        cell.title = `${date.getDate()}. ${date.getMonth()+1}. ${currentYear} ${hour}:00 - ${power.toFixed(0)}W`;
                    } else {
                        cell.style.background = 'rgba(255,255,255,0.05)';
                    }
                    col.appendChild(cell);
                });
                dataDiv.appendChild(col);
            });
            contentWrapper.appendChild(dataDiv);
            gridContainer.appendChild(contentWrapper);
            heatmapDiv.appendChild(gridContainer);
        }

        function getColorForPower(power, minP, maxP) {
            const range = maxP - minP || 1;
            const ratio = Math.max(0, Math.min(1, (power - minP) / range));
            let r, g, b;
            if (ratio < 0.2)      { const t=ratio/0.2;       r=255; g=255; b=Math.round(255-t*55); }
            else if (ratio < 0.4) { const t=(ratio-0.2)/0.2; r=255; g=255; b=Math.round(200-t*200); }
            else if (ratio < 0.6) { const t=(ratio-0.4)/0.2; r=255; g=Math.round(255-t*90); b=0; }
            else if (ratio < 0.8) { const t=(ratio-0.6)/0.2; r=255; g=Math.round(165-t*100); b=0; }
            else                  { const t=(ratio-0.8)/0.2; r=Math.round(255-t*220); g=Math.round(65-t*65); b=0; }
            return `rgb(${r},${g},${b})`;
        }

        function isLeapYear(y) { return (y%4===0 && y%100!==0) || y%400===0; }
        function getDayOfYear(date) {
            const utc = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const start = new Date(Date.UTC(date.getFullYear(), 0, 0));
            return Math.floor((utc - start) / 86400000) - 1;
        }
        function getDateFromDayOfYear(day, year) { const d = new Date(year, 0, 1); d.setDate(d.getDate()+day); return d; }

        // ============================================================
        // ZOOM CONTROLS
        // ============================================================
        function resetZoom(n) { if (charts[n]) charts[n].resetZoom(); }
        function zoomIn(n)    { if (charts[n]) charts[n].zoom(1.1); }
        function zoomOut(n)   { if (charts[n]) charts[n].zoom(0.9); }

        // ============================================================
        // SLIDERS
        // ============================================================
        function initializeSliders() {
            const names = ['delta','consumption','power','voltage','current'];
            names.forEach(name => {
                const sw = document.getElementById(`${name}SliderWindow`);
                const sl = document.getElementById(`${name}Slider`);
                if (!sw || !sl) return;
                sliders[name] = { window: sw, slider: sl, isDragging: false, isResizing: false, resizeHandle: null, startX: 0, startLeft: 0, startWidth: 0, startRight: 0 };
                sw.style.left = '0%'; sw.style.width = '100%'; sw.style.right = '';
                sw.addEventListener('mousedown', e => { if (!e.target.classList.contains('chart-slider-handle')) handleSliderMouseDown(e, name); });
                const lh = sw.querySelector('.chart-slider-handle.left');
                const rh = sw.querySelector('.chart-slider-handle.right');
                if (lh) lh.addEventListener('mousedown', e => handleResizeStart(e, name, 'left'));
                if (rh) rh.addEventListener('mousedown', e => handleResizeStart(e, name, 'right'));
            });
            document.addEventListener('mousemove', handleSliderMouseMove);
            document.addEventListener('mouseup', handleSliderMouseUp);
        }

        function handleSliderMouseDown(e, name) {
            const s = sliders[name]; if (!s) return;
            s.isDragging = true; s.startX = e.clientX;
            const pr = s.slider.getBoundingClientRect(), wr = s.window.getBoundingClientRect();
            s.startLeft = ((wr.left - pr.left) / pr.width) * 100;
            s.startWidth = (wr.width / pr.width) * 100;
            e.preventDefault(); e.stopPropagation();
        }

        function handleResizeStart(e, name, handle) {
            const s = sliders[name]; if (!s) return;
            s.isResizing = true; s.resizeHandle = handle; s.startX = e.clientX;
            const pr = s.slider.getBoundingClientRect(), wr = s.window.getBoundingClientRect();
            s.startLeft = ((wr.left - pr.left) / pr.width) * 100;
            s.startWidth = (wr.width / pr.width) * 100;
            s.startRight = s.startLeft + s.startWidth;
            e.stopPropagation(); e.preventDefault();
        }

        function handleSliderMouseMove(e) {
            let needsUpdate = false, updateName = null;
            Object.keys(sliders).forEach(name => {
                const s = sliders[name];
                if (!s.isDragging && !s.isResizing) return;
                const pr = s.slider.getBoundingClientRect();
                const dp = ((e.clientX - s.startX) / pr.width) * 100;
                if (s.isDragging) {
                    let nl = Math.max(0, Math.min(100 - s.startWidth, s.startLeft + dp));
                    s.window.style.left = nl.toFixed(2)+'%'; s.window.style.width = s.startWidth.toFixed(2)+'%'; s.window.style.right = '';
                } else if (s.isResizing) {
                    if (s.resizeHandle === 'left') {
                        let nl = s.startLeft + dp, nw = s.startWidth - dp;
                        if (nw < 5) { nw = 5; nl = s.startRight - 5; }
                        nl = Math.max(0, nl);
                        s.window.style.left = nl.toFixed(2)+'%'; s.window.style.width = nw.toFixed(2)+'%'; s.window.style.right = '';
                    } else {
                        let nw = Math.max(5, Math.min(100 - s.startLeft, s.startWidth + dp));
                        s.window.style.width = nw.toFixed(2)+'%'; s.window.style.right = '';
                    }
                }
                needsUpdate = true; updateName = name;
            });
            if (needsUpdate && updateName) updateChartFromSlider(updateName);
        }

        function handleSliderMouseUp() {
            Object.keys(sliders).forEach(n => { sliders[n].isDragging = false; sliders[n].isResizing = false; sliders[n].resizeHandle = null; });
        }

        function updateChartFromSlider(name) {
            const s = sliders[name];
            if (!s) return;
            const pr = s.slider.getBoundingClientRect(), wr = s.window.getBoundingClientRect();
            const lp = ((wr.left - pr.left) / pr.width) * 100;
            const wp = (wr.width / pr.width) * 100;
            const rp = lp + wp;

            // Choose correct data source based on chart
            const isSpotrebaChart = (name === 'consumption' || name === 'delta');
            const sourceData = isSpotrebaChart ? filteredSpotreba : filteredData;
            if (!sourceData.length) return;

            const si = Math.max(0, Math.floor((lp/100) * sourceData.length));
            const ei = Math.min(sourceData.length, Math.ceil((rp/100) * sourceData.length));
            const sliced = sourceData.slice(si, ei);
            if (!sliced.length) return;

            const startEl = document.getElementById(`${name}SliderStart`);
            const endEl   = document.getElementById(`${name}SliderEnd`);
            if (startEl) startEl.textContent = sliced[0].datetime.toLocaleString('cs-CZ', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});
            if (endEl)   endEl.textContent   = sliced[sliced.length-1].datetime.toLocaleString('cs-CZ', {day:'2-digit',month:'2-digit',hour:'2-digit',minute:'2-digit'});

            // Update chart data + set x min/max
            if (name === 'consumption' && charts.consumption) {
                charts.consumption.data.datasets[0].data = sliced.map(d => ({x:d.datetime, y:d.kumulativniSpotrebaKwh}));
                charts.consumption.options.scales.x.min = sliced[0].datetime;
                charts.consumption.options.scales.x.max = sliced[sliced.length-1].datetime;
                charts.consumption.update('none');
            } else if (name === 'delta' && charts.delta) {
                charts.delta.data.datasets[0].data = sliced.filter(d=>d.spotreba>0).map(d=>({x:d.datetime, y:d.spotreba}));
                charts.delta.options.scales.x.min = sliced[0].datetime;
                charts.delta.options.scales.x.max = sliced[sliced.length-1].datetime;
                charts.delta.update('none');
            } else if (name === 'power' && charts.power) {
                charts.power.data.datasets[0].data = sliced.map(d=>({x:d.datetime, y:d.vykonW}));
                charts.power.options.scales.x.min = sliced[0].datetime;
                charts.power.options.scales.x.max = sliced[sliced.length-1].datetime;
                charts.power.update('none');
            } else if (name === 'voltage' && charts.voltage) {
                charts.voltage.data.datasets[0].data = sliced.map(d=>({x:d.datetime, y:d.napeti}));
                charts.voltage.options.scales.x.min = sliced[0].datetime;
                charts.voltage.options.scales.x.max = sliced[sliced.length-1].datetime;
                charts.voltage.update('none');
            } else if (name === 'current' && charts.current) {
                charts.current.data.datasets[0].data = sliced.map(d=>({x:d.datetime, y:d.proud}));
                charts.current.options.scales.x.min = sliced[0].datetime;
                charts.current.options.scales.x.max = sliced[sliced.length-1].datetime;
                charts.current.update('none');
            }
        }

        function drawSliderPreview(name, data, valueFn) {
            const canvas = document.getElementById(`${name}SliderPreview`);
            if (!canvas || !data.length) return;
            const ctx = canvas.getContext('2d');
            const w = canvas.width = canvas.offsetWidth * 2;
            const h = canvas.height = canvas.offsetHeight * 2;
            ctx.clearRect(0, 0, w, h);
            const values = data.map(valueFn);
            if (!values.length) return;
            const min = Math.min(...values), max = Math.max(...values), range = max - min || 1;
            ctx.beginPath(); ctx.strokeStyle = '#667eea'; ctx.lineWidth = 2;
            values.forEach((val, i) => {
                const x = (i / (values.length-1)) * w;
                const y = h - ((val-min)/range) * h * 0.8 - h * 0.1;
                i === 0 ? ctx.moveTo(x, y) : ctx.lineTo(x, y);
            });
            ctx.stroke();
        }
    </script>
</body>
</html>
