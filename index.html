<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spot≈ôeba Energie - Live Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@2.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@1.2.1/dist/chartjs-plugin-zoom.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-plugin-annotation/2.1.0/chartjs-plugin-annotation.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            padding: 20px;
            color: #fff;
        }

        .container {
            max-width: 1800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeIn 0.8s;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-size: 3em;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .subtitle {
            font-size: 1.2em;
            opacity: 0.8;
        }

        .live-indicator {
            display: inline-flex;
            align-items: center;
            background: rgba(102, 126, 234, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            margin-top: 15px;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }

        .live-dot {
            width: 12px;
            height: 12px;
            background: #4ade80;
            border-radius: 50%;
            margin-right: 10px;
            animation: pulse 2s infinite;
            box-shadow: 0 0 10px #4ade80;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(0.8); }
        }

        .nav-tabs {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .nav-tab {
            padding: 12px 30px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            font-size: 1em;
        }

        .nav-tab:hover {
            background: rgba(102, 126, 234, 0.2);
            border-color: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .nav-tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: rgba(102, 126, 234, 0.8);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .last-update {
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
            font-size: 0.95em;
            margin-bottom: 20px;
        }

        .page-section {
            display: none;
        }

        .page-section.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(102, 126, 234, 0.3);
            border-color: rgba(102, 126, 234, 0.3);
        }

        .stat-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .stat-label {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 10px;
        }

        .stat-value {
            font-size: 2.8em;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 5px;
        }

        .stat-timestamp {
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 10px;
            font-style: italic;
        }

        .stat-meta {
            font-size: 0.85em;
            color: rgba(255, 255, 255, 0.6);
            margin-top: 10px;
            line-height: 1.6;
        }

        .stat-trend {
            font-size: 0.95em;
            font-weight: 600;
            margin: 8px 0;
        }

        .stat-trend.up {
            color: #ef4444;
        }

        .stat-trend.down {
            color: #10b981;
        }

        .filters {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .filters label {
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .filters select, .filters input {
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
            backdrop-filter: blur(10px);
        }

        .filters select option {
            background: #1a1a2e;
            color: #fff;
        }

        .btn {
            padding: 10px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.5);
        }

        .chart-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(550px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .chart-container:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 48px rgba(102, 126, 234, 0.3);
        }

        .chart-container h2 {
            margin-bottom: 15px;
            color: #fff;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        .chart-navigator {
            position: relative;
            height: 80px;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 10px;
            padding: 10px;
        }

        .navigator-overlay {
            position: absolute;
            top: 10px;
            left: 10px;
            right: 10px;
            height: 60px;
            pointer-events: none;
        }

        .navigator-selection {
            position: absolute;
            height: 100%;
            background: rgba(102, 126, 234, 0.2);
            border: 2px solid rgba(102, 126, 234, 0.8);
            border-radius: 5px;
            pointer-events: auto;
            cursor: move;
        }

        .navigator-handle {
            position: absolute;
            top: 0;
            width: 10px;
            height: 100%;
            background: rgba(102, 126, 234, 0.8);
            cursor: ew-resize;
        }

        .navigator-handle.left {
            left: -5px;
            border-radius: 5px 0 0 5px;
        }

        .navigator-handle.right {
            right: -5px;
            border-radius: 0 5px 5px 0;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        .heatmap-container {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            padding: 25px;
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            margin-bottom: 20px;
        }

        .heatmap-wrapper {
            position: relative;
            width: 100%;
            overflow-x: visible;
            overflow-y: visible;
        }

        .heatmap-grid {
            display: grid;
            grid-template-columns: 60px 1fr;
            gap: 0;
            width: 100%;
        }

        .heatmap-y-labels {
            display: flex;
            flex-direction: column;
            gap: 0;
        }

        .heatmap-y-label {
            font-size: 0.7em;
            color: rgba(255, 255, 255, 0.7);
            text-align: right;
            padding-right: 8px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            height: 20px;
        }

        .heatmap-content-wrapper {
            display: flex;
            flex-direction: column;
        }

        .heatmap-x-labels {
            display: flex;
            height: 30px;
            position: relative;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 0;
        }

        .heatmap-month-label {
            position: absolute;
            font-size: 0.75em;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 600;
            transform: translateX(-50%);
            top: 8px;
        }

        .heatmap-data {
            display: flex;
            gap: 0;
        }

        .heatmap-day-column {
            display: flex;
            flex-direction: column;
            gap: 0;
            flex: 1;
            min-width: 2px;
        }

        .heatmap-hour-cell {
            height: 20px;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }

        .heatmap-hour-cell:hover {
            transform: scale(1.5);
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.6);
            border: 2px solid rgba(255, 255, 255, 0.8);
        }

        .heatmap-legend {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 15px;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }

        .heatmap-legend-gradient {
            flex: 1;
            height: 25px;
            border-radius: 5px;
            background: linear-gradient(to right, 
                #ffffc8,
                #ffff80,
                #ffff00,
                #ffd700,
                #ffa500,
                #ff6600,
                #ff3300,
                #ff0000,
                #990000,
                #330000
            );
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 1.5em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: rgba(220, 53, 69, 0.2);
            border: 1px solid rgba(220, 53, 69, 0.3);
            color: #ff6b6b;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
        }

        .success {
            background: rgba(40, 167, 69, 0.2);
            border: 1px solid rgba(40, 167, 69, 0.3);
            color: #51cf66;
            padding: 15px;
            border-radius: 15px;
            margin-bottom: 20px;
            text-align: center;
            animation: fadeIn 0.5s;
            backdrop-filter: blur(10px);
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .chart-controls button {
            padding: 6px 12px;
            background: rgba(102, 126, 234, 0.3);
            color: white;
            border: 1px solid rgba(102, 126, 234, 0.5);
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.85em;
            transition: all 0.3s;
            backdrop-filter: blur(10px);
        }

        .chart-controls button:hover {
            background: rgba(102, 126, 234, 0.5);
            transform: translateY(-2px);
        }

        .cost-display {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            text-align: center;
        }

        .cost-value {
            font-size: 1.8em;
            font-weight: bold;
            color: #ffc107;
            margin: 5px 0;
        }

        .page-title {
            font-size: 2em;
            margin-bottom: 20px;
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #f093fb 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        @media (max-width: 768px) {
            h1 { font-size: 2em; }
            .chart-grid { grid-template-columns: 1fr; }
            .stats-grid { 
                grid-template-columns: 1fr;
            }
            .stat-value { font-size: 2.2em; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚ö° Dashboard Spot≈ôeby Energie</h1>
            <p class="subtitle">Real-time monitoring odbƒõru elektrick√© energie</p>
            <div class="live-indicator">
                <div class="live-dot"></div>
                <span>LIVE DATA - ThingSpeak</span>
            </div>
            <div style="margin-top: 15px; font-size: 1.1em; font-weight: 600; color: rgba(255,255,255,0.9);">
                üïê <span id="currentTime">Naƒç√≠t√°n√≠...</span>
            </div>
            
            <div class="nav-tabs">
                <div class="nav-tab active" onclick="switchPage('overview')">üìä P≈ôehled</div>
                <div class="nav-tab" onclick="switchPage('aggregated')">üìà Agregovan√° spot≈ôeba</div>
                <div class="nav-tab" onclick="switchPage('statistics')">üìâ Detailn√≠ statistiky</div>
                <div class="nav-tab" onclick="switchPage('heatmap')">üî• Heatmapa</div>
            </div>
        </header>

        <div id="lastUpdate" class="last-update"></div>
        <div id="loading" class="loading">‚è≥ Naƒç√≠t√°m data z ThingSpeak</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="success" class="success" style="display: none;"></div>

        <div class="filters" id="filters" style="display: none;">
            <div class="filter-group">
                <label>üìÖ Obdob√≠:</label>
                <select id="timeRange" onchange="updateCharts()">
                    <option value="1">Posledn√≠ den</option>
                    <option value="3">Posledn√≠ 3 dny</option>
                    <option value="7" selected>Posledn√≠ch 7 dn√≠</option>
                    <option value="14">Posledn√≠ch 14 dn√≠</option>
                    <option value="30">Posledn√≠ch 30 dn√≠</option>
                    <option value="all">V≈°echna data</option>
                    <option value="custom">Vlastn√≠ rozsah</option>
                </select>
            </div>
            
            <div class="filter-group" id="customDateGroup" style="display: none;">
                <label>Od:</label>
                <input type="date" id="dateFrom" onchange="updateCharts()">
                <label>Do:</label>
                <input type="date" id="dateTo" onchange="updateCharts()">
            </div>
            
            <div class="filter-group">
                <label>üí∞ Cena kWh:</label>
                <input type="number" id="pricePerKwh" value="4.5" step="0.1" min="0" onchange="updateCharts()" style="width: 100px;">
                <span>Kƒç</span>
            </div>

            <button class="btn" onclick="loadData()" style="margin-left: auto;">
                üîÑ Obnovit data
            </button>
        </div>

        <!-- Str√°nka 1: P≈ôehled -->
        <div id="page-overview" class="page-section active">
            <div class="stats-grid" id="statsGrid" style="display: none;"></div>

            <div class="chart-grid" id="chartsGrid" style="display: none;">
                <div class="chart-container" id="deltaChartContainer">
                    <h2>üìâ P≈ô√≠r≈Østek spot≈ôeby</h2>
                    <p style="color: rgba(255,255,255,0.6); margin-bottom: 10px; font-size: 0.85em;">Rozd√≠l spot≈ôeby mezi mƒõ≈ôen√≠mi</p>
                    <div class="chart-controls">
                        <button onclick="resetZoom('delta')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('delta')">üîç+</button>
                        <button onclick="zoomOut('delta')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="deltaChart"></canvas>
                    </div>
                </div>

                <div class="chart-container" id="consumptionChartContainer">
                    <h2>üìä Kumulativn√≠ spot≈ôeba</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('consumption')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('consumption')">üîç+</button>
                        <button onclick="zoomOut('consumption')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="consumptionChart"></canvas>
                    </div>
                </div>

                <div class="chart-container" id="powerChartContainer">
                    <h2>‚ö° Okam≈æit√Ω v√Ωkon</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('power')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('power')">üîç+</button>
                        <button onclick="zoomOut('power')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="powerChart"></canvas>
                    </div>
                </div>

                <div class="chart-container" id="voltageChartContainer">
                    <h2>üîå Napƒõt√≠</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('voltage')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('voltage')">üîç+</button>
                        <button onclick="zoomOut('voltage')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="voltageChart"></canvas>
                    </div>
                </div>

                <div class="chart-container" id="currentChartContainer">
                    <h2>üåä Proud</h2>
                    <div class="chart-controls">
                        <button onclick="resetZoom('current')">‚Ü∫ Reset</button>
                        <button onclick="zoomIn('current')">üîç+</button>
                        <button onclick="zoomOut('current')">üîç-</button>
                    </div>
                    <div class="chart-wrapper">
                        <canvas id="currentChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Str√°nka 2: Agregovan√° spot≈ôeba -->
        <div id="page-aggregated" class="page-section">
            <h2 class="page-title">üìà Agregovan√° spot≈ôeba</h2>
            <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 30px;">Celkov√° spot≈ôeba za jednotliv√° obdob√≠</p>
            
            <div class="chart-grid">
                <div class="chart-container">
                    <h2>üìÖ Spot≈ôeba po dnech</h2>
                    <div class="chart-wrapper">
                        <canvas id="dailyConsumptionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h2>üìÜ Spot≈ôeba po mƒõs√≠c√≠ch</h2>
                    <div class="chart-wrapper">
                        <canvas id="monthlyConsumptionChart"></canvas>
                    </div>
                </div>
                <div class="chart-container full-width">
                    <h2>üìä Spot≈ôeba po roc√≠ch</h2>
                    <div class="chart-wrapper">
                        <canvas id="yearlyConsumptionChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Str√°nka 3: Detailn√≠ statistiky -->
        <div id="page-statistics" class="page-section">
            <h2 class="page-title">üìâ Detailn√≠ statistiky</h2>
            <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 30px;">Podrobn√© statistick√© √∫daje za vybran√© obdob√≠</p>
            <div id="statisticsGrid" class="stats-grid"></div>
        </div>

        <!-- Str√°nka 4: Heatmapa -->
        <div id="page-heatmap" class="page-section">
            <h2 class="page-title">üî• Roƒçn√≠ heatmapa spot≈ôeby</h2>
            <p style="color: rgba(255,255,255,0.6); text-align: center; margin-bottom: 30px;">Pr≈Ømƒõrn√Ω odbƒõr podle dne v roce a hodiny</p>
            
            <div class="heatmap-container">
                <div class="heatmap-wrapper">
                    <div id="heatmapGrid"></div>
                </div>
                <div class="heatmap-legend">
                    <span style="font-size: 0.85em; color: rgba(255,255,255,0.8); font-weight: 600;">V√Ωkon:</span>
                    <span style="font-size: 0.85em; color: rgba(255,255,255,0.7);" id="heatmapMin">0W</span>
                    <div class="heatmap-legend-gradient"></div>
                    <span style="font-size: 0.85em; color: rgba(255,255,255,0.7);" id="heatmapMax">3000W</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const CHANNEL_ID = '3100560';
        const AUTO_REFRESH_INTERVAL = 5 * 60 * 1000;

        let rawData = [];
        let charts = {};
        let navigators = {};
        let autoRefreshTimer = null;
        let currentPage = 'overview';

        function switchPage(pageName) {
            currentPage = pageName;
            
            document.querySelectorAll('.page-section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById('page-' + pageName).classList.add('active');
            event.target.classList.add('active');
        }

        function formatDateTime(date) {
            return date.toLocaleString('cs-CZ', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
        }

        window.addEventListener('DOMContentLoaded', function() {
            updateCurrentTime();
            setInterval(updateCurrentTime, 1000);
            
            loadData();
            autoRefreshTimer = setInterval(loadData, AUTO_REFRESH_INTERVAL);
        });

        function updateCurrentTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('cs-CZ', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false
            });
            const dateString = now.toLocaleDateString('cs-CZ', {
                day: '2-digit',
                month: '2-digit',
                year: 'numeric'
            });
            
            const timeElement = document.getElementById('currentTime');
            if (timeElement) {
                timeElement.textContent = `${dateString} ${timeString}`;
            }
        }

        function resetZoom(chartName) {
            if (charts[chartName]) {
                charts[chartName].resetZoom();
            }
        }

        function zoomIn(chartName) {
            if (charts[chartName]) {
                charts[chartName].zoom(1.1);
            }
        }

        function zoomOut(chartName) {
            if (charts[chartName]) {
                charts[chartName].zoom(0.9);
            }
        }

        async function loadData() {
            const url = `https://api.thingspeak.com/channels/${CHANNEL_ID}/feeds.json?results=8000000`;
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('success').style.display = 'none';

            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: { 'Accept': 'application/json' }
                });
                
                if (!response.ok) {
                    throw new Error('Nelze naƒç√≠st data z ThingSpeak');
                }
                
                const data = await response.json();
                parseThingSpeakData(data);
                
                document.getElementById('lastUpdate').textContent = 
                    `Posledn√≠ aktualizace: ${formatDateTime(new Date())} | Naƒçteno ${rawData.length} z√°znam≈Ø`;
                
                document.getElementById('success').textContent = 
                    `‚úÖ √öspƒõ≈°nƒõ naƒçteno ${rawData.length} mƒõ≈ôen√≠!`;
                document.getElementById('success').style.display = 'block';
                setTimeout(() => {
                    document.getElementById('success').style.display = 'none';
                }, 5000);
            } catch (error) {
                showError(error.message);
            }
        }

        function parseThingSpeakData(data) {
            try {
                if (!data.feeds || data.feeds.length === 0) {
                    throw new Error('≈Ω√°dn√° data z ThingSpeak');
                }

                rawData = data.feeds
                    .filter(feed => feed.field1 && feed.field2 && feed.field3 && feed.field4)
                    .map(feed => ({
                        datetime: new Date(feed.created_at),
                        spotrebaKwh: parseFloat(feed.field1) || 0,
                        vykonW: parseFloat(feed.field2) || 0,
                        napeti: parseFloat(feed.field3) || 0,
                        proud: parseFloat(feed.field4) || 0
                    }));

                if (rawData.length === 0) {
                    throw new Error('≈Ω√°dn√° platn√° data');
                }

                rawData.sort((a, b) => a.datetime - b.datetime);

                let cumulative = 0;
                rawData.forEach(d => {
                    cumulative += d.spotrebaKwh;
                    d.kumulativniSpotrebaKwh = cumulative;
                });

                document.getElementById('loading').style.display = 'none';
                showDashboard();
                
                if (Object.keys(charts).length === 0) {
                    initializeCharts();
                    setTimeout(createNavigatorsForCharts, 500);
                }
                
                updateCharts();
            } catch (error) {
                showError('Chyba zpracov√°n√≠ dat: ' + error.message);
            }
        }

        function showError(msg) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error').textContent = '‚ùå ' + msg;
            document.getElementById('error').style.display = 'block';
        }

        function showDashboard() {
            document.getElementById('filters').style.display = 'flex';
            document.getElementById('statsGrid').style.display = 'grid';
            document.getElementById('chartsGrid').style.display = 'grid';
        }

        function updateCharts() {
            const range = document.getElementById('timeRange')?.value || '7';
            const dateFrom = document.getElementById('dateFrom')?.value;
            const dateTo = document.getElementById('dateTo')?.value;
            
            const customDateGroup = document.getElementById('customDateGroup');
            if (range === 'custom') {
                customDateGroup.style.display = 'flex';
            } else {
                customDateGroup.style.display = 'none';
            }

            let filteredData = [...rawData];

            if (range === 'custom' && dateFrom && dateTo) {
                const from = new Date(dateFrom);
                const to = new Date(dateTo);
                to.setHours(23, 59, 59, 999);
                filteredData = filteredData.filter(d => d.datetime >= from && d.datetime <= to);
            } else if (range !== 'all') {
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - parseInt(range));
                filteredData = filteredData.filter(d => d.datetime >= cutoff);
            }

            updateStats(filteredData);
            updateAllCharts(filteredData);
            updateAggregatedCharts(filteredData);
            updateStatistics(filteredData);
            updateHeatmap(rawData);
        }

        function updateStats(data) {
            const pricePerKwh = parseFloat(document.getElementById('pricePerKwh')?.value || 4.5);
            
            const stats = {
                vykon: calcStatsWithTime(data.map(d => ({ value: d.vykonW, time: d.datetime }))),
                napeti: calcStatsWithTime(data.map(d => ({ value: d.napeti, time: d.datetime }))),
                proud: calcStatsWithTime(data.map(d => ({ value: d.proud, time: d.datetime }))),
                spotreba: {
                    total: data.length > 0 ? data[data.length - 1].kumulativniSpotrebaKwh - data[0].kumulativniSpotrebaKwh : 0,
                    current: data.length > 0 ? data[data.length - 1].kumulativniSpotrebaKwh : 0
                }
            };

            const totalCost = stats.spotreba.total * pricePerKwh;

            document.getElementById('statsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">OKAM≈ΩIT√ù V√ùKON</div>
                    <div class="stat-value">${stats.vykon.current.value.toFixed(0)} W</div>
                    <div class="stat-timestamp">üìÖ ${formatDateTime(stats.vykon.current.time)}</div>
                    <div class="stat-trend ${stats.vykon.trend >= 0 ? 'up' : 'down'}">
                        ${stats.vykon.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.vykon.trend).toFixed(0)} W od p≈ôedchoz√≠ho
                    </div>
                    <div class="stat-meta">
                        Max: ${stats.vykon.max.value.toFixed(0)} W<br>
                        <small>${formatDateTime(stats.vykon.max.time)}</small><br>
                        Pr≈Ømƒõr: ${stats.vykon.avg.toFixed(0)} W
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">CELKOV√Å SPOT≈òEBA</div>
                    <div class="stat-value">${stats.spotreba.total.toFixed(2)} kWh</div>
                    <div class="stat-timestamp">Za zvolen√© obdob√≠</div>
                    <div class="cost-display">
                        <div style="font-size: 0.9em; opacity: 0.8;">N√°klady</div>
                        <div class="cost-value">${totalCost.toFixed(2)} Kƒç</div>
                        <div style="font-size: 0.8em; opacity: 0.7;">p≈ôi ${pricePerKwh} Kƒç/kWh</div>
                    </div>
                    <div class="stat-meta" style="margin-top: 10px;">
                        Kumulativn√≠: ${stats.spotreba.current.toFixed(2)} kWh
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üîå</div>
                    <div class="stat-label">NAPƒöT√ç</div>
                    <div class="stat-value">${stats.napeti.current.value.toFixed(1)} V</div>
                    <div class="stat-timestamp">üìÖ ${formatDateTime(stats.napeti.current.time)}</div>
                    <div class="stat-trend ${stats.napeti.trend >= 0 ? 'up' : 'down'}">
                        ${stats.napeti.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.napeti.trend).toFixed(1)} V
                    </div>
                    <div class="stat-meta">
                        Min: ${stats.napeti.min.value.toFixed(1)} V<br>
                        <small>${formatDateTime(stats.napeti.min.time)}</small><br>
                        Max: ${stats.napeti.max.value.toFixed(1)} V<br>
                        <small>${formatDateTime(stats.napeti.max.time)}</small>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üåä</div>
                    <div class="stat-label">PROUD</div>
                    <div class="stat-value">${stats.proud.current.value.toFixed(2)} A</div>
                    <div class="stat-timestamp">üìÖ ${formatDateTime(stats.proud.current.time)}</div>
                    <div class="stat-trend ${stats.proud.trend >= 0 ? 'up' : 'down'}">
                        ${stats.proud.trend >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(stats.proud.trend).toFixed(2)} A
                    </div>
                    <div class="stat-meta">
                        Max: ${stats.proud.max.value.toFixed(2)} A<br>
                        <small>${formatDateTime(stats.proud.max.time)}</small><br>
                        Pr≈Ømƒõr: ${stats.proud.avg.toFixed(2)} A
                    </div>
                </div>
            `;
        }

        function calcStatsWithTime(items) {
            if (items.length === 0) return { 
                current: {value: 0, time: new Date()}, 
                min: {value: 0, time: new Date()}, 
                max: {value: 0, time: new Date()}, 
                avg: 0, 
                trend: 0 
            };
            
            const values = items.map(i => i.value);
            const current = items[items.length - 1];
            const previous = items[Math.max(0, items.length - 10)];
            
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const minItem = items.find(i => i.value === minValue);
            const maxItem = items.find(i => i.value === maxValue);
            
            return {
                current,
                min: minItem,
                max: maxItem,
                avg: values.reduce((a, b) => a + b, 0) / values.length,
                trend: current.value - previous.value
            };
        }

        function initializeCharts() {
            const zoomOptions = {
                zoom: {
                    wheel: { enabled: true, speed: 0.1 },
                    pinch: { enabled: true },
                    mode: 'x'
                },
                pan: {
                    enabled: true,
                    mode: 'x'
                }
            };

            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        display: true,
                        labels: { color: 'rgba(255,255,255,0.8)' }
                    },
                    zoom: zoomOptions,
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    },
                    annotation: { annotations: {} }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: { 
                            unit: 'hour',
                            displayFormats: { 
                                hour: 'HH:mm',
                                day: 'dd.MM'
                            },
                            tooltipFormat: 'dd.MM.yyyy HH:mm'
                        },
                        ticks: { color: 'rgba(255,255,255,0.7)' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            };

            charts.delta = new Chart(document.getElementById('deltaChart'), {
                type: 'bar',
                data: { datasets: [] },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            title: { display: true, text: 'kWh', color: 'rgba(255,255,255,0.8)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    barPercentage: 1.0,
                    categoryPercentage: 1.0
                }
            });

            charts.consumption = new Chart(document.getElementById('consumptionChart'), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            title: { display: true, text: 'kWh', color: 'rgba(255,255,255,0.8)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            charts.power = new Chart(document.getElementById('powerChart'), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            title: { display: true, text: 'W', color: 'rgba(255,255,255,0.8)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            charts.voltage = new Chart(document.getElementById('voltageChart'), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            title: { display: true, text: 'V', color: 'rgba(255,255,255,0.8)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            charts.current = new Chart(document.getElementById('currentChart'), {
                type: 'line',
                data: { datasets: [] },
                options: {
                    ...commonOptions,
                    scales: {
                        ...commonOptions.scales,
                        y: {
                            title: { display: true, text: 'A', color: 'rgba(255,255,255,0.8)' },
                            ticks: { color: 'rgba(255,255,255,0.7)' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });

            const aggregatedOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(0,0,0,0.8)',
                        titleColor: '#fff',
                        bodyColor: '#fff'
                    }
                },
                scales: {
                    x: {
                        ticks: { color: 'rgba(255,255,255,0.7)' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    },
                    y: {
                        title: { display: true, text: 'kWh', color: 'rgba(255,255,255,0.8)' },
                        ticks: { color: 'rgba(255,255,255,0.7)' },
                        grid: { color: 'rgba(255,255,255,0.1)' }
                    }
                }
            };

            charts.dailyConsumption = new Chart(document.getElementById('dailyConsumptionChart'), {
                type: 'bar',
                data: { datasets: [] },
                options: aggregatedOptions
            });

            charts.monthlyConsumption = new Chart(document.getElementById('monthlyConsumptionChart'), {
                type: 'bar',
                data: { datasets: [] },
                options: aggregatedOptions
            });

            charts.yearlyConsumption = new Chart(document.getElementById('yearlyConsumptionChart'), {
                type: 'bar',
                data: { datasets: [] },
                options: aggregatedOptions
            });
        }

        function updateAllCharts(data) {
            const deltaData = [];
            for (let i = 0; i < data.length; i++) {
                if (data[i].spotrebaKwh > 0) {
                    deltaData.push({ 
                        x: data[i].datetime, 
                        y: data[i].spotrebaKwh 
                    });
                }
            }
            
            charts.delta.data.datasets = [{
                label: 'P≈ô√≠r≈Østek spot≈ôeby (kWh)',
                data: deltaData,
                backgroundColor: 'rgba(255, 193, 7, 0.8)',
                borderColor: 'rgba(255, 193, 7, 1)',
                borderWidth: 1
            }];

            charts.consumption.data.datasets = [{
                label: 'Kumulativn√≠ spot≈ôeba (kWh)',
                data: data.map(d => ({ x: d.datetime, y: d.kumulativniSpotrebaKwh })),
                borderColor: '#4caf50',
                backgroundColor: 'rgba(76, 175, 80, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 2
            }];

            charts.power.data.datasets = [{
                label: 'V√Ωkon (W)',
                data: data.map(d => ({ x: d.datetime, y: d.vykonW })),
                borderColor: '#ff9800',
                backgroundColor: 'rgba(255, 152, 0, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 2
            }];

            charts.voltage.data.datasets = [{
                label: 'Napƒõt√≠ (V)',
                data: data.map(d => ({ x: d.datetime, y: d.napeti })),
                borderColor: '#2196f3',
                backgroundColor: 'rgba(33, 150, 243, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 2
            }];

            charts.current.data.datasets = [{
                label: 'Proud (A)',
                data: data.map(d => ({ x: d.datetime, y: d.proud })),
                borderColor: '#9c27b0',
                backgroundColor: 'rgba(156, 39, 176, 0.2)',
                tension: 0.4,
                fill: true,
                pointRadius: 2
            }];

            const daysDiff = data.length > 0 ? (data[data.length - 1].datetime - data[0].datetime) / (1000 * 60 * 60 * 24) : 0;
            const showMidnightLines = daysDiff <= 60;
            
            if (showMidnightLines) {
                addMidnightLines(charts.delta, data);
                addMidnightLines(charts.consumption, data);
                addMidnightLines(charts.power, data);
                addMidnightLines(charts.voltage, data);
                addMidnightLines(charts.current, data);
            } else {
                ['delta', 'consumption', 'power', 'voltage', 'current'].forEach(chartName => {
                    if (charts[chartName] && charts[chartName].options.plugins.annotation) {
                        charts[chartName].options.plugins.annotation.annotations = {};
                    }
                });
            }

            updateNavigators(data);
            Object.values(charts).forEach(chart => chart.update());
        }

        function addMidnightLines(chart, data) {
            if (!data || data.length === 0) return;
            
            const midnights = [];
            const startDate = new Date(data[0].datetime);
            const endDate = new Date(data[data.length - 1].datetime);
            
            let current = new Date(startDate);
            current.setHours(0, 0, 0, 0);
            current.setDate(current.getDate() + 1);
            
            while (current <= endDate) {
                midnights.push(current.getTime());
                current = new Date(current);
                current.setDate(current.getDate() + 1);
            }
            
            if (!chart.options.plugins) chart.options.plugins = {};
            if (!chart.options.plugins.annotation) {
                chart.options.plugins.annotation = { annotations: {} };
            }
            
            chart.options.plugins.annotation.annotations = {};
            
            midnights.forEach((midnight, idx) => {
                chart.options.plugins.annotation.annotations[`midnight${idx}`] = {
                    type: 'line',
                    xMin: midnight,
                    xMax: midnight,
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderWidth: 2,
                    borderDash: [5, 5]
                };
            });
        }

        function getColorForPower(power, minPower, maxPower) {
            const range = maxPower - minPower || 1;
            const ratio = Math.max(0, Math.min(1, (power - minPower) / range));
            
            let r, g, b;
            
            if (ratio < 0.2) {
                const t = ratio / 0.2;
                r = 255;
                g = 255;
                b = Math.round(255 - t * 55);
            } else if (ratio < 0.4) {
                const t = (ratio - 0.2) / 0.2;
                r = 255;
                g = 255;
                b = Math.round(200 - t * 200);
            } else if (ratio < 0.6) {
                const t = (ratio - 0.4) / 0.2;
                r = 255;
                g = Math.round(255 - t * 90);
                b = 0;
            } else if (ratio < 0.8) {
                const t = (ratio - 0.6) / 0.2;
                r = 255;
                g = Math.round(165 - t * 100);
                b = 0;
            } else {
                const t = (ratio - 0.8) / 0.2;
                r = Math.round(255 - t * 220);
                g = Math.round(65 - t * 65);
                b = 0;
            }
            
            return `rgb(${r}, ${g}, ${b})`;
        }

        function updateHeatmap(data) {
            const currentYear = new Date().getFullYear();
            const daysInYear = isLeapYear(currentYear) ? 366 : 365;
            
            const matrix = Array(daysInYear).fill(null).map(() => Array(24).fill(null).map(() => []));
            
            data.forEach(d => {
                if (d.datetime.getFullYear() !== currentYear) return;
                
                const dayOfYear = getDayOfYear(d.datetime);
                const hour = d.datetime.getHours();
                
                if (dayOfYear >= 0 && dayOfYear < daysInYear && hour >= 0 && hour < 24) {
                    matrix[dayOfYear][hour].push(d.vykonW);
                }
            });

            const avgMatrix = matrix.map(day => 
                day.map(hours => 
                    hours.length > 0 ? hours.reduce((a, b) => a + b, 0) / hours.length : null
                )
            );

            const allPowers = avgMatrix.flat().filter(p => p !== null);
            if (allPowers.length === 0) {
                document.getElementById('heatmapGrid').innerHTML = '<p style="color: rgba(255,255,255,0.6); padding: 20px;">Nedostatek dat pro zobrazen√≠ heatmapy</p>';
                return;
            }

            const minPower = Math.min(...allPowers);
            const maxPower = Math.max(...allPowers);

            document.getElementById('heatmapMin').textContent = minPower.toFixed(0) + 'W';
            document.getElementById('heatmapMax').textContent = maxPower.toFixed(0) + 'W';

            const heatmapDiv = document.getElementById('heatmapGrid');
            heatmapDiv.innerHTML = '';

            const gridContainer = document.createElement('div');
            gridContainer.className = 'heatmap-grid';

            const yLabels = document.createElement('div');
            yLabels.className = 'heatmap-y-labels';
            
            for (let hour = 0; hour < 24; hour++) {
                const label = document.createElement('div');
                label.className = 'heatmap-y-label';
                label.textContent = hour + ':00';
                yLabels.appendChild(label);
            }
            gridContainer.appendChild(yLabels);

            const contentWrapper = document.createElement('div');
            contentWrapper.className = 'heatmap-content-wrapper';

            const xLabels = document.createElement('div');
            xLabels.className = 'heatmap-x-labels';
            
            const monthNames = ['Led', '√öno', 'B≈ôe', 'Dub', 'Kvƒõ', 'ƒåvn', 'ƒåvc', 'Srp', 'Z√°≈ô', '≈ò√≠j', 'Lis', 'Pro'];
            const daysInMonth = [31, isLeapYear(currentYear) ? 29 : 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31];

            let cumulativeDays = 0;
            monthNames.forEach((month, idx) => {
                const monthLabel = document.createElement('div');
                monthLabel.className = 'heatmap-month-label';
                monthLabel.textContent = month;
                const position = ((cumulativeDays + daysInMonth[idx] / 2) / daysInYear) * 100;
                monthLabel.style.left = position + '%';
                xLabels.appendChild(monthLabel);
                cumulativeDays += daysInMonth[idx];
            });
            contentWrapper.appendChild(xLabels);

            const dataDiv = document.createElement('div');
            dataDiv.className = 'heatmap-data';

            avgMatrix.forEach((dayData, dayIndex) => {
                const dayColumn = document.createElement('div');
                dayColumn.className = 'heatmap-day-column';

                dayData.forEach((power, hour) => {
                    const cell = document.createElement('div');
                    cell.className = 'heatmap-hour-cell';

                    if (power !== null) {
                        cell.style.background = getColorForPower(power, minPower, maxPower);
                        
                        const date = getDateFromDayOfYear(dayIndex, currentYear);
                        cell.title = `${date.getDate()}. ${date.getMonth() + 1}. ${currentYear} ${hour}:00 - ${power.toFixed(0)}W`;
                    } else {
                        cell.style.background = 'rgba(255,255,255,0.05)';
                    }

                    dayColumn.appendChild(cell);
                });

                dataDiv.appendChild(dayColumn);
            });

            contentWrapper.appendChild(dataDiv);
            gridContainer.appendChild(contentWrapper);
            heatmapDiv.appendChild(gridContainer);
        }

        function isLeapYear(year) {
            return (year % 4 === 0 && year % 100 !== 0) || (year % 400 === 0);
        }

        function getDayOfYear(date) {
            const utcDate = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
            const start = new Date(Date.UTC(date.getFullYear(), 0, 0));
            const diff = utcDate - start;
            const oneDay = 1000 * 60 * 60 * 24;
            return Math.floor(diff / oneDay) - 1;
        }

        function getDateFromDayOfYear(dayOfYear, year) {
            const date = new Date(year, 0, 1);
            date.setDate(date.getDate() + dayOfYear);
            return date;
        }

        function createNavigatorsForCharts() {
            ['delta', 'consumption', 'power', 'voltage', 'current'].forEach(chartName => {
                const containerId = chartName + 'ChartContainer';
                createNavigator(chartName, containerId);
            });
        }

        function createNavigator(chartName, containerId) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const navDiv = document.createElement('div');
            navDiv.className = 'chart-navigator';
            navDiv.id = `${chartName}-navigator`;
            
            const canvas = document.createElement('canvas');
            canvas.id = `${chartName}-nav-canvas`;
            navDiv.appendChild(canvas);

            container.appendChild(navDiv);

            const navChart = new Chart(canvas, {
                type: chartName === 'delta' ? 'bar' : 'line',
                data: { datasets: [] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: { enabled: false }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            display: false
                        },
                        y: {
                            display: false
                        }
                    },
                    elements: {
                        point: { radius: 0 }
                    }
                }
            });

            navigators[chartName] = {
                chart: navChart,
                mainChart: charts[chartName],
                container: navDiv,
                canvas: canvas
            };

            setupNavigatorInteraction(chartName);
        }

        function setupNavigatorInteraction(chartName) {
            const nav = navigators[chartName];
            if (!nav) return;

            const overlay = document.createElement('div');
            overlay.className = 'navigator-overlay';
            
            const selection = document.createElement('div');
            selection.className = 'navigator-selection';
            selection.style.left = '0%';
            selection.style.width = '100%';

            const leftHandle = document.createElement('div');
            leftHandle.className = 'navigator-handle left';
            
            const rightHandle = document.createElement('div');
            rightHandle.className = 'navigator-handle right';

            selection.appendChild(leftHandle);
            selection.appendChild(rightHandle);
            overlay.appendChild(selection);
            nav.container.appendChild(overlay);

            nav.selection = selection;

            let isDragging = false;
            let dragType = null;
            let startX = 0;
            let startLeft = 0;
            let startWidth = 0;

            const startDrag = (e, type) => {
                isDragging = true;
                dragType = type;
                startX = e.clientX || e.touches[0].clientX;
                startLeft = parseFloat(selection.style.left);
                startWidth = parseFloat(selection.style.width);
                e.preventDefault();
            };

            const onDrag = (e) => {
                if (!isDragging) return;
                
                const containerWidth = overlay.offsetWidth;
                const clientX = e.clientX || e.touches[0].clientX;
                const deltaX = ((clientX - startX) / containerWidth) * 100;

                if (dragType === 'move') {
                    let newLeft = startLeft + deltaX;
                    newLeft = Math.max(0, Math.min(100 - startWidth, newLeft));
                    selection.style.left = newLeft + '%';
                } else if (dragType === 'left') {
                    let newLeft = startLeft + deltaX;
                    let newWidth = startWidth - deltaX;
                    newLeft = Math.max(0, newLeft);
                    newWidth = Math.max(5, Math.min(startLeft + startWidth, newWidth));
                    selection.style.left = newLeft + '%';
                    selection.style.width = newWidth + '%';
                } else if (dragType === 'right') {
                    let newWidth = startWidth + deltaX;
                    newWidth = Math.max(5, Math.min(100 - startLeft, newWidth));
                    selection.style.width = newWidth + '%';
                }

                updateMainChartZoom(chartName, selection);
            };

            const endDrag = () => {
                isDragging = false;
                dragType = null;
            };

            leftHandle.addEventListener('mousedown', (e) => startDrag(e, 'left'));
            leftHandle.addEventListener('touchstart', (e) => startDrag(e, 'left'));
            
            rightHandle.addEventListener('mousedown', (e) => startDrag(e, 'right'));
            rightHandle.addEventListener('touchstart', (e) => startDrag(e, 'right'));
            
            selection.addEventListener('mousedown', (e) => {
                if (e.target === selection) startDrag(e, 'move');
            });
            selection.addEventListener('touchstart', (e) => {
                if (e.target === selection) startDrag(e, 'move');
            });

            document.addEventListener('mousemove', onDrag);
            document.addEventListener('touchmove', onDrag);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('touchend', endDrag);
        }

        function updateMainChartZoom(chartName, selection) {
            const nav = navigators[chartName];
            if (!nav || !nav.mainChart) return;

            const left = parseFloat(selection.style.left);
            const width = parseFloat(selection.style.width);
            
            const datasets = nav.chart.data.datasets;
            if (!datasets || datasets.length === 0) return;

            const data = datasets[0].data;
            if (!data || data.length === 0) return;

            const startIdx = Math.floor((left / 100) * data.length);
            const endIdx = Math.ceil(((left + width) / 100) * data.length);

            const xScale = nav.mainChart.scales.x;
            if (xScale && data[startIdx] && data[endIdx - 1]) {
                xScale.options.min = data[startIdx].x;
                xScale.options.max = data[endIdx - 1].x;
                nav.mainChart.update('none');
            }
        }

        function updateNavigators(data) {
            ['delta', 'consumption', 'power', 'voltage', 'current'].forEach(chartName => {
                const nav = navigators[chartName];
                if (!nav) return;

                const mainData = charts[chartName].data.datasets[0];
                if (mainData) {
                    nav.chart.data.datasets = [{
                        data: mainData.data,
                        borderColor: mainData.borderColor || mainData.backgroundColor,
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        fill: true,
                        tension: 0.4
                    }];
                    nav.chart.update('none');
                    
                    if (nav.selection) {
                        nav.selection.style.left = '0%';
                        nav.selection.style.width = '100%';
                        
                        const xScale = nav.mainChart.scales.x;
                        if (xScale) {
                            delete xScale.options.min;
                            delete xScale.options.max;
                        }
                    }
                }
            });
        }

        function updateAggregatedCharts(data) {
            if (data.length === 0) return;

            const dailyData = {};
            data.forEach(d => {
                const dateKey = d.datetime.toLocaleDateString('cs-CZ');
                if (!dailyData[dateKey]) {
                    dailyData[dateKey] = 0;
                }
                dailyData[dateKey] += d.spotrebaKwh;
            });

            const dailyLabels = Object.keys(dailyData);
            const dailyValues = Object.values(dailyData);

            charts.dailyConsumption.data = {
                labels: dailyLabels,
                datasets: [{
                    label: 'Spot≈ôeba (kWh)',
                    data: dailyValues,
                    backgroundColor: 'rgba(76, 175, 80, 0.8)',
                    borderColor: 'rgba(76, 175, 80, 1)',
                    borderWidth: 1
                }]
            };
            charts.dailyConsumption.update();

            const monthlyData = {};
            data.forEach(d => {
                const monthKey = `${d.datetime.getFullYear()}-${String(d.datetime.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) {
                    monthlyData[monthKey] = 0;
                }
                monthlyData[monthKey] += d.spotrebaKwh;
            });

            const monthlyLabels = Object.keys(monthlyData).map(key => {
                const [year, month] = key.split('-');
                const monthNames = ['Led', '√öno', 'B≈ôe', 'Dub', 'Kvƒõ', 'ƒåvn', 'ƒåvc', 'Srp', 'Z√°≈ô', '≈ò√≠j', 'Lis', 'Pro'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            const monthlyValues = Object.values(monthlyData);

            charts.monthlyConsumption.data = {
                labels: monthlyLabels,
                datasets: [{
                    label: 'Spot≈ôeba (kWh)',
                    data: monthlyValues,
                    backgroundColor: 'rgba(33, 150, 243, 0.8)',
                    borderColor: 'rgba(33, 150, 243, 1)',
                    borderWidth: 1
                }]
            };
            charts.monthlyConsumption.update();

            const yearlyData = {};
            data.forEach(d => {
                const year = d.datetime.getFullYear();
                if (!yearlyData[year]) {
                    yearlyData[year] = 0;
                }
                yearlyData[year] += d.spotrebaKwh;
            });

            const yearlyLabels = Object.keys(yearlyData);
            const yearlyValues = Object.values(yearlyData);

            charts.yearlyConsumption.data = {
                labels: yearlyLabels,
                datasets: [{
                    label: 'Spot≈ôeba (kWh)',
                    data: yearlyValues,
                    backgroundColor: 'rgba(156, 39, 176, 0.8)',
                    borderColor: 'rgba(156, 39, 176, 1)',
                    borderWidth: 1
                }]
            };
            charts.yearlyConsumption.update();
        }

        function updateStatistics(data) {
            if (data.length === 0) {
                document.getElementById('statisticsGrid').innerHTML = '<p style="color: rgba(255,255,255,0.6);">Nedostatek dat</p>';
                return;
            }

            const pricePerKwh = parseFloat(document.getElementById('pricePerKwh')?.value || 4.5);

            const powers = data.map(d => d.vykonW);
            const voltages = data.map(d => d.napeti);
            const currents = data.map(d => d.proud);
            const consumptions = data.map(d => d.spotrebaKwh);

            const totalConsumption = consumptions.reduce((a, b) => a + b, 0);
            const avgPower = powers.reduce((a, b) => a + b, 0) / powers.length;
            const maxPower = Math.max(...powers);
            const minPower = Math.min(...powers);
            const maxPowerTime = data[powers.indexOf(maxPower)].datetime;
            const minPowerTime = data[powers.indexOf(minPower)].datetime;

            const hourlyConsumption = Array(24).fill(0);
            const hourlyCounts = Array(24).fill(0);
            data.forEach(d => {
                const hour = d.datetime.getHours();
                hourlyConsumption[hour] += d.vykonW;
                hourlyCounts[hour]++;
            });
            const avgHourlyPower = hourlyConsumption.map((sum, i) => hourlyCounts[i] > 0 ? sum / hourlyCounts[i] : 0);
            const peakHour = avgHourlyPower.indexOf(Math.max(...avgHourlyPower));
            const offPeakHour = avgHourlyPower.indexOf(Math.min(...avgHourlyPower.filter(p => p > 0)));

            const weekdayConsumption = Array(7).fill(0);
            const weekdayCounts = Array(7).fill(0);
            data.forEach(d => {
                const day = d.datetime.getDay();
                weekdayConsumption[day] += d.vykonW;
                weekdayCounts[day]++;
            });
            const avgWeekdayPower = weekdayConsumption.map((sum, i) => weekdayCounts[i] > 0 ? sum / weekdayCounts[i] : 0);
            const peakWeekday = avgWeekdayPower.indexOf(Math.max(...avgWeekdayPower));
            const weekdayNames = ['Nedƒõle', 'Pondƒõl√≠', '√öter√Ω', 'St≈ôeda', 'ƒåtvrtek', 'P√°tek', 'Sobota'];

            const timeSpan = (data[data.length - 1].datetime - data[0].datetime) / (1000 * 60 * 60 * 24);
            const avgDailyConsumption = totalConsumption / timeSpan;

            const avgVoltage = voltages.reduce((a, b) => a + b, 0) / voltages.length;
            const avgCurrent = currents.reduce((a, b) => a + b, 0) / currents.length;
            const powerFactor = avgPower / (avgVoltage * avgCurrent);

            const totalCost = totalConsumption * pricePerKwh;
            const avgDailyCost = totalCost / timeSpan;
            const projectedMonthlyCost = avgDailyCost * 30;
            const projectedYearlyCost = avgDailyCost * 365;

            document.getElementById('statisticsGrid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">OBDOB√ç</div>
                    <div class="stat-value">${timeSpan.toFixed(1)}</div>
                    <div class="stat-meta">dn≈Ø monitorov√°n√≠</div>
                    <div class="stat-meta" style="margin-top: 10px;">
                        Od: ${formatDateTime(data[0].datetime)}<br>
                        Do: ${formatDateTime(data[data.length - 1].datetime)}
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚ö°</div>
                    <div class="stat-label">PR≈ÆMƒöRN√ù V√ùKON</div>
                    <div class="stat-value">${avgPower.toFixed(0)} W</div>
                    <div class="stat-meta">
                        Maximum: ${maxPower.toFixed(0)} W<br>
                        <small>${formatDateTime(maxPowerTime)}</small><br>
                        Minimum: ${minPower.toFixed(0)} W<br>
                        <small>${formatDateTime(minPowerTime)}</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üïê</div>
                    <div class="stat-label">≈†PIƒåKA DNE</div>
                    <div class="stat-value">${peakHour}:00</div>
                    <div class="stat-meta">
                        Pr≈Ømƒõrn√Ω v√Ωkon: ${avgHourlyPower[peakHour].toFixed(0)} W<br>
                        Nejni≈æ≈°√≠: ${offPeakHour}:00 (${avgHourlyPower[offPeakHour].toFixed(0)} W)
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üìÖ</div>
                    <div class="stat-label">NEJVY≈†≈†√ç DEN</div>
                    <div class="stat-value">${weekdayNames[peakWeekday]}</div>
                    <div class="stat-meta">
                        Pr≈Ømƒõrn√Ω v√Ωkon: ${avgWeekdayPower[peakWeekday].toFixed(0)} W
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üìà</div>
                    <div class="stat-label">DENN√ç SPOT≈òEBA</div>
                    <div class="stat-value">${avgDailyConsumption.toFixed(2)}</div>
                    <div class="stat-meta">kWh/den (pr≈Ømƒõr)</div>
                    <div class="cost-display">
                        <div style="font-size: 0.9em; opacity: 0.8;">Denn√≠ n√°klady</div>
                        <div class="cost-value">${avgDailyCost.toFixed(2)} Kƒç</div>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-label">PROJEKCE N√ÅKLAD≈Æ</div>
                    <div class="stat-value">${projectedMonthlyCost.toFixed(0)}</div>
                    <div class="stat-meta">Kƒç/mƒõs√≠c (odhad)</div>
                    <div class="stat-meta" style="margin-top: 10px;">
                        Roƒçn√≠ odhad: ${projectedYearlyCost.toFixed(0)} Kƒç
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üîå</div>
                    <div class="stat-label">√öƒåIN√çK</div>
                    <div class="stat-value">${powerFactor.toFixed(3)}</div>
                    <div class="stat-meta">
                        Power Factor (cos œÜ)<br>
                        <small>${powerFactor > 0.95 ? 'V√Ωborn√Ω' : powerFactor > 0.85 ? 'Dobr√Ω' : 'Ke zlep≈°en√≠'}</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üìä</div>
                    <div class="stat-label">Mƒö≈òEN√ç</div>
                    <div class="stat-value">${data.length}</div>
                    <div class="stat-meta">
                        Celkov√Ω poƒçet z√°znam≈Ø<br>
                        Pr≈Ømƒõrn√Ω interval: ${((timeSpan * 24 * 60) / data.length).toFixed(1)} min
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">‚öôÔ∏è</div>
                    <div class="stat-label">STABILITA NAPƒöT√ç</div>
                    <div class="stat-value">${avgVoltage.toFixed(1)} V</div>
                    <div class="stat-meta">
                        Max: ${Math.max(...voltages).toFixed(1)} V<br>
                        Min: ${Math.min(...voltages).toFixed(1)} V<br>
                        Rozptyl: ${(Math.max(...voltages) - Math.min(...voltages)).toFixed(1)} V
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üåä</div>
                    <div class="stat-label">PR≈ÆMƒöRN√ù PROUD</div>
                    <div class="stat-value">${avgCurrent.toFixed(2)} A</div>
                    <div class="stat-meta">
                        Maximum: ${Math.max(...currents).toFixed(2)} A<br>
                        Minimum: ${Math.min(...currents).toFixed(2)} A
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üí°</div>
                    <div class="stat-label">EFEKTIVITA</div>
                    <div class="stat-value">${(avgPower / 1000 * 24).toFixed(1)}</div>
                    <div class="stat-meta">
                        kWh/den p≈ôi trval√©m pr≈Ømƒõrn√©m v√Ωkonu<br>
                        <small>Skuteƒçn√°: ${avgDailyConsumption.toFixed(2)} kWh/den</small>
                    </div>
                </div>

                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-label">CELKEM ZA OBDOB√ç</div>
                    <div class="stat-value">${totalConsumption.toFixed(2)}</div>
                    <div class="stat-meta">kWh</div>
                    <div class="cost-display">
                        <div style="font-size: 0.9em; opacity: 0.8;">Celkov√© n√°klady</div>
                        <div class="cost-value">${totalCost.toFixed(2)} Kƒç</div>
                    </div>
                </div>
            `;
        }
    </script>
</body>

</html>
